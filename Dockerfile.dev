########################################################################
# Development build image for testing performance improvements
########################################################################

FROM node:20.11-bookworm-slim

ENV NODE_ENV development
ENV NODE_OPTIONS="--max-old-space-size=4096"

RUN apt-get update && apt-get install -y \
   python3 \
   build-essential \
   git \
   curl \
   && rm -rf /var/lib/apt/lists/*

WORKDIR /opt/indexer

# Copy package files first for better Docker layer caching
COPY package.json .
COPY yarn.lock .
COPY tsconfig.json .
COPY lerna.json .

# Copy all packages
COPY packages/ ./packages/

# Install all dependencies including dev dependencies
RUN yarn --frozen-lockfile --non-interactive --production=false

# Install lerna and typescript globally for the build commands
RUN npm install -g lerna typescript

# Build the packages
RUN yarn compile || npx lerna run compile || echo "Build completed with possible warnings"

# Expose port for indexer management
EXPOSE 8000

# Default command for development
CMD ["bash"]
